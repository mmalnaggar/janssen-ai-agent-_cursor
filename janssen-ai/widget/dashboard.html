<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Janssen AI - Analytics Dashboard</title>
  <meta name="description" content="Janssen AI analytics â€“ conversations, intents, escalation rate, channel distribution.">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      /* Janssen Gray & Red */
      --primary: #C41E3A;
      --primary-dark: #A01830;
      --bg-dark: #1A1A1A;
      --bg-card: #2D2D2D;
      --text: #F5F5F5;
      --text-muted: #A3A3A3;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: #525252;
    }
    
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      min-height: 100vh;
    }
    
    /* Header */
    .header {
      background: var(--bg-card);
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
    }
    
    .logo {
      font-size: 24px;
      font-weight: 700;
      color: var(--primary);
    }
    
    .header-actions {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
    }
    
    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }
    
    .btn-outline:hover {
      background: var(--bg-card);
    }
    
    /* Main Content */
    .main {
      padding: 40px;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .page-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .page-subtitle {
      color: var(--text-muted);
      margin-bottom: 32px;
    }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }
    
    .stat-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 24px;
      border: 1px solid var(--border);
    }
    
    .stat-label {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: 700;
    }
    
    .stat-change {
      font-size: 14px;
      margin-top: 8px;
    }
    
    .stat-change.up { color: var(--success); }
    .stat-change.down { color: var(--danger); }
    
    /* Charts Section */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
      margin-bottom: 40px;
    }
    
    .chart-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 24px;
      border: 1px solid var(--border);
    }
    
    .chart-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
    }
    
    /* Bar Chart */
    .bar-chart {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .bar-item {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .bar-label {
      width: 120px;
      font-size: 14px;
      color: var(--text-muted);
    }
    
    .bar-container {
      flex: 1;
      height: 24px;
      background: var(--bg-dark);
      border-radius: 4px;
      overflow: hidden;
    }
    
    .bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--primary-dark));
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    
    .bar-value {
      width: 60px;
      text-align: right;
      font-weight: 600;
    }
    
    /* Donut Chart */
    .donut-container {
      display: flex;
      align-items: center;
      gap: 40px;
    }
    
    .donut {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      background: conic-gradient(
        var(--primary) 0deg 252deg,
        var(--success) 252deg 324deg,
        var(--warning) 324deg 360deg
      );
      position: relative;
    }
    
    .donut::before {
      content: '';
      position: absolute;
      top: 30px;
      left: 30px;
      width: 90px;
      height: 90px;
      background: var(--bg-card);
      border-radius: 50%;
    }
    
    .donut-legend {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    
    .legend-dot.chat { background: var(--primary); }
    .legend-dot.whatsapp { background: var(--success); }
    .legend-dot.voice { background: var(--warning); }
    
    /* Recent Activity */
    .activity-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 24px;
      border: 1px solid var(--border);
    }
    
    .activity-list {
      display: flex;
      flex-direction: column;
    }
    
    .activity-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px 0;
      border-bottom: 1px solid var(--border);
    }
    
    .activity-item:last-child {
      border-bottom: none;
    }
    
    .activity-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    
    .activity-icon.sales { background: rgba(34, 197, 94, 0.2); }
    .activity-icon.support { background: rgba(59, 130, 246, 0.2); }
    .activity-icon.complaint { background: rgba(239, 68, 68, 0.2); }
    .activity-icon.escalation { background: rgba(245, 158, 11, 0.2); }
    
    .activity-content {
      flex: 1;
    }
    
    .activity-title {
      font-weight: 500;
      margin-bottom: 4px;
    }
    
    .activity-meta {
      font-size: 13px;
      color: var(--text-muted);
    }
    
    .activity-time {
      font-size: 13px;
      color: var(--text-muted);
    }
    
    /* Status Badge */
    .badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .badge-success { background: rgba(34, 197, 94, 0.2); color: var(--success); }
    .badge-warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
    .badge-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
    
    /* Loading State */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: var(--text-muted);
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .header { padding: 16px 20px; }
      .main { padding: 20px; }
      .charts-grid { grid-template-columns: 1fr; }
      .donut-container { flex-direction: column; }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="logo">Janssen AI</div>
    <div class="header-actions">
      <span id="last-updated" style="color: var(--text-muted); font-size: 14px;">Loading...</span>
      <button class="btn btn-outline" onclick="loadStats()">â†» Refresh</button>
      <button class="btn btn-primary" onclick="window.open('demo.html')">Open Chat</button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main">
    <h1 class="page-title">Analytics Dashboard</h1>
    <p class="page-subtitle">Real-time insights from your AI customer service</p>

    <!-- Stats Grid -->
    <div class="stats-grid" id="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Conversations</div>
        <div class="stat-value" id="stat-total">--</div>
        <div class="stat-change up" id="stat-total-change">Loading...</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Today</div>
        <div class="stat-value" id="stat-today">--</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">This Week</div>
        <div class="stat-value" id="stat-week">--</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Escalation Rate</div>
        <div class="stat-value" id="stat-escalation">--</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Avg Confidence</div>
        <div class="stat-value" id="stat-confidence">--</div>
      </div>
      <div class="stat-card" style="border-left: 3px solid #10b981;">
        <div class="stat-label">Leads Captured</div>
        <div class="stat-value" id="stat-leads">--</div>
        <div class="stat-change up" id="stat-leads-change"></div>
      </div>
    </div>

    <!-- Charts Grid -->
    <div class="charts-grid">
      <!-- Intent Distribution -->
      <div class="chart-card">
        <h3 class="chart-title">Top Intents</h3>
        <div class="bar-chart" id="intent-chart">
          <div class="loading"><div class="spinner"></div></div>
        </div>
      </div>

      <!-- Channel Distribution -->
      <div class="chart-card">
        <h3 class="chart-title">By Channel</h3>
        <div class="donut-container">
          <div class="donut" id="channel-donut"></div>
          <div class="donut-legend" id="channel-legend">
            <div class="legend-item">
              <span class="legend-dot chat"></span>
              <span>Chat: <strong id="channel-chat">--</strong></span>
            </div>
            <div class="legend-item">
              <span class="legend-dot whatsapp"></span>
              <span>WhatsApp: <strong id="channel-whatsapp">--</strong></span>
            </div>
            <div class="legend-item">
              <span class="legend-dot voice"></span>
              <span>Voice: <strong id="channel-voice">--</strong></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Agent Performance -->
    <div class="chart-card" style="margin-bottom: 40px;">
      <h3 class="chart-title">Agent Usage</h3>
      <div class="bar-chart" id="agent-chart">
        <div class="loading"><div class="spinner"></div></div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="activity-card">
      <h3 class="chart-title">Recent Activity</h3>
      <div class="activity-list" id="activity-list">
        <div class="loading"><div class="spinner"></div></div>
      </div>
    </div>
  </main>

  <script>
    // Configuration
    // Use local API when running locally, n8n webhook in production
    const STATS_API = window.JANSSEN_STATS_URL
      || (window.location.hostname === 'localhost' ? '/api/stats' : 'https://n8n-2-7fw9.onrender.com/webhook/janssen-stats');

    // Load stats on page load
    document.addEventListener('DOMContentLoaded', loadStats);

    async function loadStats() {
      document.getElementById('last-updated').textContent = 'Loading...';
      
      try {
        const response = await fetch(STATS_API);
        
        if (!response.ok) {
          throw new Error('Failed to fetch stats');
        }
        
        const data = await response.json();
        renderStats(data);
        document.getElementById('last-updated').textContent = 
          'Updated: ' + new Date().toLocaleTimeString();
        
      } catch (error) {
        console.error('Error loading stats:', error);
        document.getElementById('last-updated').textContent = 'Error loading data';
        showDemoData();
      }
    }

    function renderStats(data) {
      // Summary stats
      if (data.summary) {
        document.getElementById('stat-total').textContent = 
          data.summary.total_conversations?.toLocaleString() || '--';
        document.getElementById('stat-today').textContent = 
          data.summary.today?.toLocaleString() || '--';
        document.getElementById('stat-week').textContent = 
          data.summary.this_week?.toLocaleString() || '--';
        document.getElementById('stat-escalation').textContent = 
          data.summary.escalation_rate || '--';
        document.getElementById('stat-confidence').textContent = 
          data.summary.avg_confidence || '--';
        document.getElementById('stat-total-change').textContent =
          `+${data.summary.today || 0} today`;
      }

      // Leads stats
      if (data.leads) {
        document.getElementById('stat-leads').textContent =
          data.leads.total?.toLocaleString() || '0';
        document.getElementById('stat-leads-change').textContent =
          `+${data.leads.today || 0} today`;
      }

      // Intent chart
      if (data.top_intents) {
        renderBarChart('intent-chart', data.top_intents.map(i => ({
          label: i.intent.replace('_', ' '),
          value: i.count,
          percentage: parseFloat(i.percentage)
        })));
      }

      // Agent chart
      if (data.by_agent) {
        const total = Object.values(data.by_agent).reduce((a, b) => a + b, 0);
        renderBarChart('agent-chart', Object.entries(data.by_agent).map(([agent, count]) => ({
          label: agent.charAt(0).toUpperCase() + agent.slice(1),
          value: count,
          percentage: (count / total * 100)
        })));
      }

      // Channel distribution
      if (data.by_channel) {
        document.getElementById('channel-chat').textContent = 
          data.by_channel.chat?.toLocaleString() || '0';
        document.getElementById('channel-whatsapp').textContent = 
          data.by_channel.whatsapp?.toLocaleString() || '0';
        document.getElementById('channel-voice').textContent = 
          data.by_channel.voice?.toLocaleString() || '0';
      }

      // Recent activity (real data from API)
      renderActivity(data.recent_activity);
    }

    function renderBarChart(containerId, items) {
      const container = document.getElementById(containerId);
      const maxValue = Math.max(...items.map(i => i.value));
      
      container.innerHTML = items.map(item => `
        <div class="bar-item">
          <span class="bar-label">${item.label}</span>
          <div class="bar-container">
            <div class="bar-fill" style="width: ${item.percentage || (item.value / maxValue * 100)}%"></div>
          </div>
          <span class="bar-value">${item.value.toLocaleString()}</span>
        </div>
      `).join('');
    }

    function timeAgo(dateStr) {
      if (!dateStr) return '';
      const now = new Date();
      const date = new Date(dateStr);
      const seconds = Math.floor((now - date) / 1000);
      if (seconds < 60) return 'just now';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes} min ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      return `${days}d ago`;
    }

    function renderActivity(activities) {
      const agentIcons = {
        sales: 'ðŸ’°', support: 'ðŸ“¦', warranty: 'ðŸ›¡ï¸', complaint: 'ðŸ˜¤', escalation: 'âš ï¸'
      };

      // Fallback demo data if no real activities
      if (!activities || activities.length === 0) {
        activities = [
          { agent: 'sales', intent: 'SALES_PRICE', channel: 'chat', language: 'ar', message_preview: 'Price inquiry', time: new Date().toISOString() },
          { agent: 'support', intent: 'DELIVERY', channel: 'chat', language: 'ar', message_preview: 'Delivery question', time: new Date().toISOString() }
        ];
      }

      document.getElementById('activity-list').innerHTML = activities.map(a => {
        const icon = agentIcons[a.agent] || 'ðŸ’¬';
        const agentType = a.agent || 'support';
        const lang = a.language === 'ar' ? 'Arabic' : 'English';
        const channel = (a.channel || 'chat').charAt(0).toUpperCase() + (a.channel || 'chat').slice(1);
        const title = a.message_preview || (a.intent ? a.intent.replace(/_/g, ' ') : 'Message');
        const escalatedBadge = a.escalated ? ' <span style="color:#ef4444;font-size:11px;">â€¢ escalated</span>' : '';

        return `
          <div class="activity-item">
            <div class="activity-icon ${agentType}">${icon}</div>
            <div class="activity-content">
              <div class="activity-title">${title}${escalatedBadge}</div>
              <div class="activity-meta">${channel} â€¢ ${lang} â€¢ ${agentType}</div>
            </div>
            <div class="activity-time">${timeAgo(a.time)}</div>
          </div>
        `;
      }).join('');
    }

    function showDemoData() {
      // Show demo data if API fails
      renderStats({
        summary: {
          total_conversations: 1247,
          today: 45,
          this_week: 312,
          escalation_rate: '8.5%',
          avg_confidence: '82.3%'
        },
        top_intents: [
          { intent: 'SALES_PRICE', count: 423, percentage: '33.9' },
          { intent: 'DELIVERY', count: 287, percentage: '23.0' },
          { intent: 'WARRANTY', count: 198, percentage: '15.9' },
          { intent: 'STORE_INFO', count: 156, percentage: '12.5' },
          { intent: 'COMPLAINT', count: 89, percentage: '7.1' }
        ],
        by_agent: {
          sales: 520,
          support: 456,
          warranty: 198,
          complaint: 89,
          escalation: 42
        },
        by_channel: {
          chat: 812,
          whatsapp: 398,
          voice: 37
        },
        recent_activity: [
          { agent: 'sales', intent: 'SALES_PRICE', channel: 'chat', language: 'ar', message_preview: 'Ø¨ÙƒØ§Ù… Ø§Ù„Ù…Ø±ØªØ¨Ø© Ø§Ù„Ø§ÙˆØ±Ø«ÙˆØ¨ÙŠØ¯ÙŠÙƒØŸ', time: new Date(Date.now() - 2*60000).toISOString() },
          { agent: 'support', intent: 'DELIVERY', channel: 'whatsapp', language: 'ar', message_preview: 'Ø§Ù„ØªÙˆØµÙŠÙ„ Ø¨ÙƒØ§Ù… Ù„Ù„Ø§Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©ØŸ', time: new Date(Date.now() - 5*60000).toISOString() },
          { agent: 'escalation', intent: 'HUMAN_REQUEST', channel: 'chat', language: 'en', escalated: true, message_preview: 'I want to speak to a human', time: new Date(Date.now() - 12*60000).toISOString() },
          { agent: 'warranty', intent: 'WARRANTY', channel: 'chat', language: 'ar', message_preview: 'Ø§Ù„Ø¶Ù…Ø§Ù† Ø¨ØªØ§Ø¹ Ø§Ù„Ù…Ø±ØªØ¨Ø© ÙƒØ§Ù… Ø³Ù†Ø©ØŸ', time: new Date(Date.now() - 18*60000).toISOString() },
          { agent: 'complaint', intent: 'COMPLAINT', channel: 'whatsapp', language: 'ar', escalated: true, message_preview: 'Ø§Ù„Ù…Ø±ØªØ¨Ø© ÙˆØµÙ„Øª Ø¨Ø¹ÙŠØ¨', time: new Date(Date.now() - 25*60000).toISOString() }
        ],
        leads: { total: 34, today: 5, by_interest_level: { hot: 12, warm: 15, cold: 7 } }
      });
    }

    // Auto-refresh every 60 seconds
    setInterval(loadStats, 60000);
  </script>

</body>
</html>
