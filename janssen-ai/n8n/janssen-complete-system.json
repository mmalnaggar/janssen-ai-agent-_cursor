{
  "name": "Janssen_AI_Complete",
  "nodes": [
    {
      "id": "webhook_in",
      "name": "1_Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [100, 500],
      "parameters": {
        "path": "janssen-ai-incoming",
        "httpMethod": "POST",
        "responseMode": "responseNode"
      }
    },
    {
      "id": "normalize",
      "name": "2_Normalize",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [350, 500],
      "parameters": {
        "jsCode": "const rawInput = $input.first().json;\nconst body = rawInput.body || rawInput;\n\nfunction containsArabic(text) {\n  return /[\\u0600-\\u06FF]/.test(text);\n}\n\nconst userMessage = (body.user_message || body.message || '').trim();\nconst sessionId = body.session_id || 'session_' + Date.now();\nconst channel = body.channel || 'chat';\nconst phone = body.phone || '';\n\nlet language = body.language;\nif (!language) language = containsArabic(userMessage) ? 'ar' : 'en';\n\nreturn {\n  json: {\n    user_message: userMessage,\n    session_id: sessionId,\n    channel: channel,\n    language: language,\n    phone: phone,\n    metadata: body.metadata || {},\n    timestamp: new Date().toISOString()\n  }\n};"
      }
    },
    {
      "id": "detect_intent",
      "name": "3_Detect_Intent",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [600, 500],
      "parameters": {
        "jsCode": "const input = $input.first().json;\nconst msg = input.user_message;\nconst lang = input.language;\n\nconst intents = [\n  { intent: 'LEGAL_THREAT', agent: 'escalation', ar: ['Ù…Ø­Ø§Ù…ÙŠ', 'Ù‚Ø§Ù†ÙˆÙ†', 'Ø´Ø±Ø·Ø©', 'Ù‡Ù†Ø´Ø±', 'ÙÙŠØ³Ø¨ÙˆÙƒ'], en: ['lawyer', 'legal', 'police', 'facebook'] },\n  { intent: 'COMPLAINT', agent: 'complaint', ar: ['Ø´ÙƒÙˆÙ‰', 'Ù…Ø´ÙƒÙ„Ø©', 'Ø²Ø¹Ù„Ø§Ù†', 'Ù…Ø´ Ø±Ø§Ø¶ÙŠ', 'Ø§Ø³ØªØ±Ø¬Ø§Ø¹'], en: ['complaint', 'problem', 'angry', 'refund'] },\n  { intent: 'HUMAN_REQUEST', agent: 'escalation', ar: ['Ù…ÙˆØ¸Ù', 'Ø®Ø¯Ù…Ø© Ø¹Ù…Ù„Ø§Ø¡', 'Ù…Ø¯ÙŠØ±'], en: ['human', 'customer service', 'manager'] },\n  { intent: 'WARRANTY', agent: 'warranty', ar: ['Ø¶Ù…Ø§Ù†', 'ØªØµÙ„ÙŠØ­', 'ØµÙŠØ§Ù†Ø©'], en: ['warranty', 'repair', 'maintenance'] },\n  { intent: 'SALES_PRICE', agent: 'sales', ar: ['Ø³Ø¹Ø±', 'Ø¨ÙƒØ§Ù…', 'ÙƒØ§Ù…', 'Ø¹Ø±ÙˆØ¶', 'Ø®ØµÙ…'], en: ['price', 'cost', 'how much', 'discount'] },\n  { intent: 'SALES_REC', agent: 'sales', ar: ['Ø¹Ø§ÙŠØ² Ø§Ø´ØªØ±ÙŠ', 'Ù…Ø±ØªØ¨Ø©', 'Ø§Ù†ØµØ­Ù†ÙŠ', 'Ø§ÙØ¶Ù„'], en: ['buy', 'mattress', 'recommend', 'best'] },\n  { intent: 'DELIVERY', agent: 'support', ar: ['ØªÙˆØµÙŠÙ„', 'Ø´Ø­Ù†', 'ÙŠÙˆØµÙ„ Ø§Ù…ØªÙ‰'], en: ['delivery', 'shipping', 'arrive'] },\n  { intent: 'STORE_INFO', agent: 'support', ar: ['ÙØ±Ø¹', 'Ø¹Ù†ÙˆØ§Ù†', 'Ù…ÙˆØ§Ø¹ÙŠØ¯'], en: ['store', 'address', 'hours', 'branch'] }\n];\n\nlet detected = { intent: 'GENERAL', agent: 'support', confidence: 0.5, matched: [] };\n\nfor (const def of intents) {\n  const keywords = lang === 'ar' ? def.ar : def.en;\n  const matches = keywords.filter(k => msg.includes(k));\n  if (matches.length > 0) {\n    detected = { intent: def.intent, agent: def.agent, confidence: 0.8, matched: matches };\n    break;\n  }\n}\n\nreturn { json: { ...input, ...detected } };"
      }
    },
    {
      "id": "generate_response",
      "name": "4_Generate_Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 500],
      "parameters": {
        "jsCode": "const input = $input.first().json;\nconst lang = input.language;\nconst agent = input.agent;\nconst intent = input.intent;\n\n// Product database\nconst products = [\n  { id: 'prod_001', name_ar: 'ÙŠØ§Ù†Ø³Ù† Ø£ÙˆØ±Ø«ÙˆØ¨ÙŠØ¯ÙŠÙƒ', name_en: 'Janssen Orthopedic', price: 12500, warranty: 10, description_ar: 'Ù…Ø±ØªØ¨Ø© Ø·Ø¨ÙŠØ© Ù„Ù„Ø¸Ù‡Ø±', description_en: 'Orthopedic mattress' },\n  { id: 'prod_002', name_ar: 'ÙŠØ§Ù†Ø³Ù† Ù…ÙŠÙ…ÙˆØ±ÙŠ ÙÙˆÙ…', name_en: 'Janssen Memory Foam', price: 15000, warranty: 12, description_ar: 'Ø±Ø§Ø­Ø© ÙØ§Ø¦Ù‚Ø© Ù…Ø¹ ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…ÙŠÙ…ÙˆØ±ÙŠ', description_en: 'Memory foam comfort' },\n  { id: 'prod_003', name_ar: 'ÙŠØ§Ù†Ø³Ù† Ø³ÙˆØ¨Ø± Ø³ÙˆÙØª', name_en: 'Janssen Super Soft', price: 10000, warranty: 8, description_ar: 'Ù†Ø¹ÙˆÙ…Ø© Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠØ©', description_en: 'Extra soft comfort' }\n];\n\nlet text = '';\nlet responseType = 'text';\nlet escalated = false;\nlet nextAction = 'await_response';\nlet productCard = null;\n\nswitch (agent) {\n  case 'sales':\n    if (intent === 'SALES_PRICE') {\n      text = lang === 'ar'\n        ? `Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…Ø±Ø§ØªØ¨:\\nâ€¢ ${products[0].name_ar}: ${products[0].price.toLocaleString()} Ø¬Ù†ÙŠÙ‡ (Ø¶Ù…Ø§Ù† ${products[0].warranty} Ø³Ù†ÙŠÙ†)\\nâ€¢ ${products[1].name_ar}: ${products[1].price.toLocaleString()} Ø¬Ù†ÙŠÙ‡ (Ø¶Ù…Ø§Ù† ${products[1].warranty} Ø³Ù†Ø©)\\nâ€¢ ${products[2].name_ar}: ${products[2].price.toLocaleString()} Ø¬Ù†ÙŠÙ‡ (Ø¶Ù…Ø§Ù† ${products[2].warranty} Ø³Ù†ÙŠÙ†)\\n\\nØ¹Ø§ÙŠØ² ØªÙØ§ØµÙŠÙ„ Ø£ÙƒØªØ± Ø¹Ù† Ù…ÙˆØ¯ÙŠÙ„ Ù…Ø¹ÙŠÙ†ØŸ`\n        : `Mattress prices:\\nâ€¢ ${products[0].name_en}: ${products[0].price.toLocaleString()} EGP (${products[0].warranty}-year warranty)\\nâ€¢ ${products[1].name_en}: ${products[1].price.toLocaleString()} EGP (${products[1].warranty}-year warranty)\\nâ€¢ ${products[2].name_en}: ${products[2].price.toLocaleString()} EGP (${products[2].warranty}-year warranty)\\n\\nWant more details about a specific model?`;\n    } else {\n      text = lang === 'ar' ? 'Ø£Ù‡Ù„Ø§Ù‹! Ø£Ù†Ø§ Ù‡Ù†Ø§ Ø£Ø³Ø§Ø¹Ø¯Ùƒ ØªØ®ØªØ§Ø± Ø§Ù„Ù…Ø±ØªØ¨Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©. Ø¹Ø§ÙŠØ² ØªØ¹Ø±Ù Ø§Ù„Ø£Ø³Ø¹Ø§Ø±ØŸ' : \"Hello! I'm here to help you choose. Want to know prices?\";\n      responseType = 'product_card';\n      productCard = {\n        id: products[0].id,\n        name: lang === 'ar' ? products[0].name_ar : products[0].name_en,\n        description: lang === 'ar' ? products[0].description_ar : products[0].description_en,\n        price: products[0].price.toLocaleString() + ' EGP',\n        warranty: products[0].warranty + (lang === 'ar' ? ' Ø³Ù†ÙŠÙ†' : ' years'),\n        url: '#'\n      };\n    }\n    break;\n\n  case 'support':\n    if (intent === 'DELIVERY') {\n      text = lang === 'ar'\n        ? 'Ø§Ù„ØªÙˆØµÙŠÙ„:\\nâ€¢ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø© ÙˆØ§Ù„Ø¬ÙŠØ²Ø©: 2-3 Ø£ÙŠØ§Ù…\\nâ€¢ Ø§Ù„Ø¥Ø³ÙƒÙ†Ø¯Ø±ÙŠØ©: 3-5 Ø£ÙŠØ§Ù…\\nâ€¢ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª: 5-7 Ø£ÙŠØ§Ù…\\n\\nğŸšš Ù…Ø¬Ø§Ù†ÙŠ Ù„Ù„Ø·Ù„Ø¨Ø§Øª ÙÙˆÙ‚ 5000 Ø¬Ù†ÙŠÙ‡\\n\\nØ¥Ù†Øª ÙÙŠÙ†ØŸ'\n        : 'Delivery times:\\nâ€¢ Cairo & Giza: 2-3 days\\nâ€¢ Alexandria: 3-5 days\\nâ€¢ Other governorates: 5-7 days\\n\\nğŸšš Free for orders above 5000 EGP\\n\\nWhere are you located?';\n    } else if (intent === 'STORE_INFO') {\n      text = lang === 'ar'\n        ? 'ÙØ±ÙˆØ¹Ù†Ø§:\\n\\nğŸ“ Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±: Ø´Ø§Ø±Ø¹ Ø¹Ø¨Ø§Ø³ Ø§Ù„Ø¹Ù‚Ø§Ø¯\\nğŸ“ Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ†: Ø´Ø§Ø±Ø¹ Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©\\n\\nğŸ•˜ Ù…Ù† 9 ØµØ¨Ø§Ø­Ø§Ù‹ Ù„Ù€ 9 Ù…Ø³Ø§Ø¡Ù‹\\nğŸ“ ÙˆØ§ØªØ³Ø§Ø¨/WhatsApp'\n        : 'Our branches:\\n\\nğŸ“ Nasr City: Abbas El-Akkad St.\\nğŸ“ Mohandessin: Arab League St.\\n\\nğŸ•˜ 9 AM to 9 PM\\nğŸ“ WhatsApp';\n    } else {\n      text = lang === 'ar' ? 'Ø£Ù‡Ù„Ø§Ù‹! Ø¥Ø²Ø§ÙŠ Ø£Ù‚Ø¯Ø± Ø£Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ù†Ù‡Ø§Ø±Ø¯Ø©ØŸ' : 'Hello! How can I help you today?';\n    }\n    break;\n\n  case 'warranty':\n    text = lang === 'ar'\n      ? 'Ø¶Ù…Ø§Ù† ÙŠØ§Ù†Ø³Ù† 10 Ø³Ù†ÙŠÙ†:\\n\\nâœ… Ø¹ÙŠÙˆØ¨ Ø§Ù„ØµÙ†Ø§Ø¹Ø©\\nâœ… ØªÙ‡Ø§Ù„Ùƒ Ø§Ù„Ø³ÙˆØ³Øª\\nâœ… Ø§Ù†Ø®ÙØ§Ø¶ Ø§Ù„Ù…Ø±ØªØ¨Ø© > 3 Ø³Ù…\\n\\nâŒ Ù…Ø´ Ø¨ÙŠØ´Ù…Ù„: Ø³ÙˆØ¡ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…ØŒ Ø§Ù„Ø¨Ù‚Ø¹ØŒ Ø§Ù„Ø­Ø±Ù‚\\n\\nÙ…Ø­ØªØ§Ø¬ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ù…Ø§Ù† ÙˆÙ„Ø§ Ø¹Ù†Ø¯Ùƒ Ù…Ø´ÙƒÙ„Ø©ØŸ'\n      : 'Janssen 10-year warranty covers:\\n\\nâœ… Manufacturing defects\\nâœ… Spring deterioration\\nâœ… Sagging > 3cm\\n\\nâŒ Excludes: Misuse, stains, burns\\n\\nNeed to activate warranty or have an issue?';\n    break;\n\n  case 'complaint':\n    text = lang === 'ar'\n      ? 'Ù…Ø¹Ù„Ø´ Ø¬Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù„ÙŠ Ø­ØµÙ„ ğŸ˜”\\n\\nØ¹Ù„Ø´Ø§Ù† Ø£Ø³Ø§Ø¹Ø¯ÙƒØŒ Ù…Ø­ØªØ§Ø¬:\\n1. Ø¥ÙŠÙ‡ Ø§Ù„Ù„ÙŠ Ø­ØµÙ„ØŸ\\n2. Ø§Ù…ØªÙ‰ Ø­ØµÙ„ØŸ\\n3. Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ\\n\\nÙ‡Ø­ÙˆÙ„Ùƒ Ø¯Ù„ÙˆÙ‚ØªÙŠ Ù„Ù‚Ø³Ù… Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰.'\n      : \"I'm truly sorry about what happened ğŸ˜”\\n\\nTo help you, I need:\\n1. What happened?\\n2. When?\\n3. Invoice number?\\n\\nConnecting you to complaints now.\";\n    escalated = true;\n    nextAction = 'transfer_to_human';\n    responseType = 'handover';\n    break;\n\n  case 'escalation':\n    text = lang === 'ar'\n      ? 'Ù‡Ø­ÙˆÙ„Ùƒ Ø¯Ù„ÙˆÙ‚ØªÙŠ Ù„Ø£Ø­Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ø®Ø¯Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡. Ø§Ø³ØªÙ†Ù‰ Ù„Ø­Ø¸Ø© Ù…Ù† ÙØ¶Ù„Ùƒ ğŸ™'\n      : 'Connecting you to a customer service representative. Please hold ğŸ™';\n    escalated = true;\n    nextAction = 'transfer_to_human';\n    responseType = 'handover';\n    break;\n\n  default:\n    text = lang === 'ar' ? 'Ø£Ù‡Ù„Ø§Ù‹! Ø¥Ø²Ø§ÙŠ Ø£Ù‚Ø¯Ø± Ø£Ø³Ø§Ø¹Ø¯ÙƒØŸ' : 'Hello! How can I help you?';\n}\n\n// Format for channel\nif (input.channel === 'chat') {\n  text = text.replace(/\\n/g, '<br>');\n} else if (input.channel === 'voice') {\n  text = text.replace(/[\\u{1F300}-\\u{1F9FF}]/gu, '').replace(/\\n+/g, '. ');\n}\n\nreturn {\n  json: {\n    ...input,\n    response_text: text,\n    response_type: responseType,\n    escalated: escalated,\n    next_action: nextAction,\n    product_card: productCard\n  }\n};"
      }
    },
    {
      "id": "format_response",
      "name": "5_Format_Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1100, 500],
      "parameters": {
        "jsCode": "const i = $input.first().json;\n\nconst content = { text: i.response_text };\nif (i.escalated) content.handover_message = i.response_text;\nconst response = {\n  response_type: i.response_type,\n  content,\n  next_action: i.next_action,\n  agent_used: i.agent,\n  intent: i.intent,\n  confidence_score: i.confidence,\n  session_id: i.session_id,\n  language: i.language,\n  channel: i.channel,\n  matched_keywords: i.matched\n};\n\nif (i.product_card) {\n  response.content.product = i.product_card;\n}\n\nif (i.escalated) {\n  response.escalation = {\n    queue: i.intent === 'COMPLAINT' ? 'complaints_queue' : 'priority_queue',\n    priority: i.intent === 'LEGAL_THREAT' ? 'critical' : 'high'\n  };\n}\n\n// Store for logging\nresponse._log_data = {\n  session_id: i.session_id,\n  phone: i.phone,\n  channel: i.channel,\n  language: i.language,\n  user_message: i.user_message,\n  bot_response: i.response_text.replace(/<br>/g, '\\n'),\n  intent: i.intent,\n  agent_used: i.agent,\n  confidence_score: i.confidence,\n  escalated: i.escalated,\n  metadata: i.metadata\n};\n\nreturn { json: response };"
      }
    },
    {
      "id": "log_to_crm",
      "name": "6_Log_To_CRM",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1350, 600],
      "parameters": {
        "method": "POST",
        "url": "={{ $env.CRM_LOG_WEBHOOK || 'https://YOUR-N8N-URL/webhook/janssen-log' }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json._log_data) }}",
        "options": {
          "timeout": 5000
        }
      },
      "continueOnFail": true
    },
    {
      "id": "respond",
      "name": "7_Return_Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [1350, 400],
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { response_type: $json.response_type, content: $json.content, next_action: $json.next_action, agent_used: $json.agent_used, intent: $json.intent, confidence_score: $json.confidence_score, session_id: $json.session_id, language: $json.language, channel: $json.channel, matched_keywords: $json.matched_keywords, escalation: $json.escalation } }}",
        "options": { "responseCode": 200 }
      }
    }
  ],
  "connections": {
    "1_Webhook": {
      "main": [[{ "node": "2_Normalize", "type": "main", "index": 0 }]]
    },
    "2_Normalize": {
      "main": [[{ "node": "3_Detect_Intent", "type": "main", "index": 0 }]]
    },
    "3_Detect_Intent": {
      "main": [[{ "node": "4_Generate_Response", "type": "main", "index": 0 }]]
    },
    "4_Generate_Response": {
      "main": [[{ "node": "5_Format_Response", "type": "main", "index": 0 }]]
    },
    "5_Format_Response": {
      "main": [
        [
          { "node": "6_Log_To_CRM", "type": "main", "index": 0 },
          { "node": "7_Return_Response", "type": "main", "index": 0 }
        ]
      ]
    }
  },
  "settings": { "executionOrder": "v1" },
  "tags": [{ "name": "janssen-ai" }, { "name": "chat" }, { "name": "crm-log" }],
  "meta": { "version": "3.0.0", "description": "Single-flow chat with product_card, handover, and optional CRM log. Response schema aligned with widget." }
}
